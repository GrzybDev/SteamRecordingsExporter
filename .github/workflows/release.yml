name: Release Build

on:
  release:
    types: [published]

  workflow_dispatch:
    inputs:
      version_type:
        type: choice
        description: 'Version Type'
        required: true
        default: rebuild
        options:
          - rebuild
          - patch
          - minor
          - major
      publish_release:
        description: "Publish Release"
        type: boolean
        required: true
        default: true

jobs:
    bump_version:
        name: Bump Version
        runs-on: ubuntu-latest
        permissions: write-all
        outputs:
          current_version: ${{ steps.get_version.outputs.current_version }}
          new_version: ${{ steps.bump.outputs.current-version || steps.bump_manual.outputs.current-version }}
        steps:
            - uses: actions/checkout@v4

            - name: Get current version
              id: get_version
              if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_type == 'rebuild' }}
              run: |
                pip install bump-my-version
                echo "current_version=$(bump-my-version show current_version)" >> $GITHUB_OUTPUT

            - name: Bump version
              id: bump
              uses: callowayproject/bump-my-version@master
              if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_type != 'rebuild' }}
              with:
                args: ${{ inputs.version_type }}

            - name: Bump version (Manual)
              id: bump_manual
              uses: callowayproject/bump-my-version@master
              if: ${{ github.event_name == 'release' }}
              with:
                args: --new-version ${{ github.ref_name }}

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                activate-environment: true
            
            - name: Update lockfile
              run: uv lock
            
            - name: Commit version bump
              if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_type != 'rebuild' && steps.bump.outputs.bumped == 'true' }}
              uses: EndBug/add-and-commit@v9
              with:
                default_author: github_actions
                message: "Bump version: ${{ steps.bump.outputs.previous-version }} → ${{ steps.bump.outputs.current-version }}"
                push: false # Temporarily push manually because of (https://github.com/EndBug/add-and-commit/issues/713)
                tag: "v${{ steps.bump.outputs.current-version }}"
                tag_push: "--force"

            - name: Commit version bump (Manual)
              if: ${{ github.event_name == 'release' && steps.bump.outputs.bumped == 'true' }}
              uses: EndBug/add-and-commit@v9
              with:
                default_author: github_actions
                message: "Bump version: ${{ steps.bump.outputs.previous-version }} → ${{ steps.bump.outputs.current-version }}"
                push: false # Temporarily push manually because of (https://github.com/EndBug/add-and-commit/issues/713)
                tag: "v${{ steps.bump.outputs.current-version }}"
                tag_push: "--force"

            - uses: ad-m/github-push-action@master
              name: Push changes
              if: ${{ steps.bump.outputs.bumped == 'true' }}
              with:
                force: true
                tags: true

    build:
        name: Build for ${{ matrix.osname }}
        permissions: write-all
        runs-on: ${{ matrix.os }}
        needs: bump_version

        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      osname: Linux
                    - os: windows-latest
                      osname: Windows

        steps:
            - uses: actions/checkout@v4
              if: ${{ github.event_name == 'release' || github.event.inputs.version_type == 'rebuild' }}

            - uses: actions/checkout@v4
              if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_type != 'rebuild' }}
              with:
                ref: v${{ needs.bump_version.outputs.new_version }}

            - name: Setup Python
              uses: actions/setup-python@v2
              with:
                python-version: 3.14

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                activate-environment: true

            - name: Build package
              run: uv build

            - name: Install project
              run: uv sync --locked --dev
            
            - name: Build executable
              run: uv run pyinstaller -F --name SteamRecordingsExporter_${{ matrix.osname }} ./src/steamrecordingsexporter/main.py
            
            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: Release_${{ matrix.osname }}
                path: dist

            - name: Upload Release (manual)
              if: ${{ github.event_name == 'release' }}
              uses: softprops/action-gh-release@v2
              with:
                files: ./dist/SteamRecordingsExporter*
            
            - name: Upload Release
              if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true' && github.event.inputs.version_type != 'rebuild') || github.event_name == 'release' }}
              uses: softprops/action-gh-release@v2
              with:
                files: ./dist/SteamRecordingsExporter*
                tag_name: v${{ needs.bump_version.outputs.new_version }}

            - name: Upload Re-Release
              if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true' && github.event.inputs.version_type == 'rebuild') && github.event_name != 'release' }}
              uses: softprops/action-gh-release@v2
              with:
                files: ./dist/SteamRecordingsExporter*
                tag_name: v${{ needs.bump_version.outputs.current_version }}
